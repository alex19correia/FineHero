"""
Enhanced API endpoints for Phase 4 services
Integration of PDF delivery, analytics, and feedback services
"""

from typing import List, Optional, Dict, Any
from fastapi import APIRouter, Depends, HTTPException, UploadFile, File, Form
from sqlalchemy.orm import Session
import json
from datetime import datetime
import time

from ....app import schemas, crud, models
from ....database import SessionLocal
from backend.services.pdf_delivery_service import PDFDeliveryService
from backend.services.analytics_service import AnalyticsService, EventData
from backend.services.feedback_service import FeedbackService, FeedbackSubmission

router = APIRouter()

# Dependency to get DB session
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@router.post("/fines/process-and-generate-defense/")
async def process_fine_and_generate_defense(
    fine_file: UploadFile = File(...),
    user_id: str = Form(...),
    include_precedents: bool = Form(True),
    template_type: str = Form("standard"),
    db: Session = Depends(get_db)
):
    """
    Complete workflow: Process PDF fine and generate defense PDF
    """
    start_time = time.time()
    
    try:
        # Initialize services
        analytics = AnalyticsService(db)
        pdf_delivery = PDFDeliveryService(db)
        defense_generator = DefenseGenerator()  # Assuming this exists
        
        # 1. Process PDF (placeholder - would use actual PDFProcessor)
        # For now, using mock data
        fine_data = {
            'id': 1,
            'date': '2025-11-11',
            'location': 'Lisbon, Portugal',
            'infractor': 'João Silva',
            'fine_amount': 120.00,
            'infraction_code': 'A123',
            'description': 'Excesso de velocidade em zona urbana'
        }
        
        processing_time = time.time() - start_time
        
        # 2. Track analytics event
        analytics.track_pdf_upload(user_id, fine_file.size, processing_time, True)
        
        # 3. Generate defense
        defense_content = f"""
        Exmos. Senhores,

        Eu, João Silva, venho por este meio apresentar defesa administrativa 
        contra o auto de contraordenação nº A123, datado de 11/11/2025, 
        referente a alegado excesso de velocidade no valor de 120€.

        [Defense content would be generated by AI here]
        """
        
        defense_gen_time = time.time() - start_time - processing_time
        
        # 4. Generate PDF
        pdf_result = pdf_delivery.generate_complete_defense_pdf(
            fine_data=fine_data,
            defense_content=defense_content,
            user_id=user_id,
            template_type=template_type,
            include_precedents=include_precedents
        )
        
        # 5. Track defense generation
        analytics.track_defense_generation(user_id, fine_data, defense_gen_time, pdf_result['success'])
        
        if pdf_result['success']:
            return {
                'success': True,
                'fine_id': fine_data['id'],
                'defense_id': pdf_result['defense_id'],
                'pdf_path': pdf_result['file_path'],
                'processing_time': pdf_result['generated_at'],
                'message': 'Defense PDF generated successfully'
            }
        else:
            raise HTTPException(status_code=500, detail=pdf_result.get('error', 'PDF generation failed'))
            
    except Exception as e:
        # Track failed attempt
        if 'analytics' in locals():
            analytics.track_event(EventData(
                event_type='error',
                user_id=user_id,
                data={'error': str(e)},
                success=False
            ))
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/analytics/user-dashboard/{user_id}")
def get_user_analytics_dashboard(
    user_id: str,
    days: int = 30,
    db: Session = Depends(get_db)
):
    """
    Get comprehensive analytics dashboard for user
    """
    try:
        analytics = AnalyticsService(db)
        dashboard_data = analytics.get_user_dashboard_data(user_id, days)
        
        if dashboard_data.get('success', False):
            return dashboard_data
        else:
            raise HTTPException(status_code=500, detail=dashboard_data.get('error', 'Analytics error'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/analytics/system-overview")
def get_system_analytics_overview(
    hours: int = 24,
    db: Session = Depends(get_db)
):
    """
    Get system-wide analytics overview
    """
    try:
        analytics = AnalyticsService(db)
        overview_data = analytics.get_system_overview(hours)
        
        if overview_data.get('success', False):
            return overview_data
        else:
            raise HTTPException(status_code=500, detail=overview_data.get('error', 'Analytics error'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/feedback/")
def submit_user_feedback(
    feedback_data: Dict[str, Any],
    db: Session = Depends(get_db)
):
    """
    Submit user feedback
    """
    try:
        feedback_service = FeedbackService(db)
        
        # Create feedback submission object
        feedback = FeedbackSubmission(
            user_id=feedback_data['user_id'],
            feedback_type=feedback_data['feedback_type'],
            title=feedback_data['title'],
            description=feedback_data['description'],
            category=feedback_data.get('category'),
            tags=feedback_data.get('tags', []),
            page_url=feedback_data.get('page_url'),
            fine_id=feedback_data.get('fine_id'),
            defense_id=feedback_data.get('defense_id'),
            overall_rating=feedback_data.get('overall_rating'),
            defense_quality_rating=feedback_data.get('defense_quality_rating'),
            user_experience_rating=feedback_data.get('user_experience_rating'),
            performance_rating=feedback_data.get('performance_rating')
        )
        
        result = feedback_service.submit_feedback(feedback)
        
        if result['success']:
            return result
        else:
            raise HTTPException(status_code=500, detail=result.get('error', 'Feedback submission failed'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/feedback/dashboard")
def get_feedback_dashboard(
    days: int = 30,
    feedback_type: Optional[str] = None,
    db: Session = Depends(get_db)
):
    """
    Get feedback dashboard data
    """
    try:
        feedback_service = FeedbackService(db)
        dashboard_data = feedback_service.get_feedback_dashboard(days, feedback_type)
        
        if dashboard_data.get('success', False):
            return dashboard_data
        else:
            raise HTTPException(status_code=500, detail=dashboard_data.get('error', 'Feedback dashboard error'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/feedback/analysis")
def analyze_feedback(
    days: int = 7,
    db: Session = Depends(get_db)
):
    """
    Perform comprehensive feedback analysis
    """
    try:
        feedback_service = FeedbackService(db)
        analysis_result = feedback_service.analyze_feedback(days)
        
        if analysis_result['success']:
            return analysis_result
        else:
            raise HTTPException(status_code=500, detail=analysis_result.get('error', 'Feedback analysis failed'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/feedback/user-history/{user_id}")
def get_user_feedback_history(
    user_id: str,
    limit: int = 20,
    db: Session = Depends(get_db)
):
    """
    Get user's feedback history
    """
    try:
        feedback_service = FeedbackService(db)
        history_data = feedback_service.get_user_feedback_history(user_id, limit)
        
        if history_data.get('success', False):
            return history_data
        else:
            raise HTTPException(status_code=500, detail=history_data.get('error', 'User feedback history error'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.patch("/feedback/{feedback_id}/status")
def update_feedback_status(
    feedback_id: int,
    status_update: Dict[str, Any],
    db: Session = Depends(get_db)
):
    """
    Update feedback status (for admin use)
    """
    try:
        feedback_service = FeedbackService(db)
        result = feedback_service.update_feedback_status(
            feedback_id,
            status_update['status'],
            status_update.get('notes')
        )
        
        if result['success']:
            return result
        else:
            raise HTTPException(status_code=500, detail=result.get('error', 'Status update failed'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/deliveries/{defense_id}/status")
def check_delivery_status(
    defense_id: str,
    db: Session = Depends(get_db)
):
    """
    Check PDF delivery status
    """
    try:
        pdf_delivery = PDFDeliveryService(db)
        status_result = pdf_delivery.get_delivery_status(defense_id)
        
        if status_result['success']:
            return status_result
        else:
            raise HTTPException(status_code=500, detail=status_result.get('error', 'Status check failed'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/deliveries/cleanup")
def cleanup_old_deliveries(
    days_old: int = 30,
    db: Session = Depends(get_db)
):
    """
    Clean up old generated defense files
    """
    try:
        pdf_delivery = PDFDeliveryService(db)
        cleanup_result = pdf_delivery.cleanup_old_files(days_old)
        
        if cleanup_result['success']:
            return cleanup_result
        else:
            raise HTTPException(status_code=500, detail=cleanup_result.get('error', 'Cleanup failed'))
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))