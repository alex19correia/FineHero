name: ðŸ”’ Security & Dependency Management

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ===== DEPENDENCY SCANNING =====
  dependency-scanning:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Python dependencies
      run: |
        cd backend
        pip install safety pip-audit
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Install Node.js dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run Python dependency audit
      run: |
        cd backend
        safety check --json --output safety-report.json || true
        pip-audit --format=json --output pip-audit-report.json || true
        
    - name: Run Node.js dependency audit
      run: |
        cd frontend
        npm audit --audit-level=high --json > npm-audit-report.json || true
        
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: dependency-security-reports
        path: |
          backend/safety-report.json
          backend/pip-audit-report.json
          frontend/npm-audit-report.json
        
    - name: Comment PR with security findings
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Check if any vulnerabilities were found
          const safetyReport = fs.existsSync('backend/safety-report.json') ? 
            JSON.parse(fs.readFileSync('backend/safety-report.json', 'utf8')) : [];
          const pipAuditReport = fs.existsSync('backend/pip-audit-report.json') ? 
            JSON.parse(fs.readFileSync('backend/pip-audit-report.json', 'utf8')) : [];
          const npmAuditReport = fs.existsSync('frontend/npm-audit-report.json') ? 
            JSON.parse(fs.readFileSync('frontend/npm-audit-report.json', 'utf8')) : [];
          
          const totalVulns = safetyReport.length + pipAuditReport.length + npmAuditReport.vulnerabilities.length;
          
          if (totalVulns > 0) {
            const comment = `## âš ï¸ Security Alert
            
            Found **${totalVulns} potential vulnerabilities**:
            - Python dependencies: ${safetyReport.length + pipAuditReport.length} issues
            - Node.js dependencies: ${npmAuditReport.vulnerabilities.length} issues
            
            Please review the uploaded security reports and update vulnerable dependencies.
            
            **High Priority**: ${npmAuditReport.vulnerabilities.filter(v => v.severity === 'high').length} high-severity vulnerabilities found.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  # ===== LICENSE COMPLIANCE =====
  license-compliance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install license checker
      run: pip install licensecheck pip-licenses
      
    - name: Check Python licenses
      run: |
        cd backend
        pip-licenses --format=json --output-file=python-licenses.json
        pip-licenses --fail-on="GPL" || echo "Warning: GPL licenses found"
        
    - name: Check Node.js licenses
      run: |
        cd frontend
        npm install -g license-checker
        license-checker --json --out node-licenses.json
        
    - name: Upload license reports
      uses: actions/upload-artifact@v3
      with:
        name: license-reports
        path: |
          backend/python-licenses.json
          frontend/node-licenses.json

  # ===== SECRET SCANNING =====
  secret-scanning:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
        
    - name: Run GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ===== CONTAINER SCANNING =====
  container-scanning:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build Docker image
      run: |
        cd backend
        docker build -t finehero-backend:test .
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: finehero-backend:test
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # ===== DEPENDENCY UPDATES =====
  dependency-updates:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Update Python dependencies
      run: |
        cd backend
        pip install pip-tools
        pip-compile --upgrade requirements.in || echo "No requirements.in found"
        
    - name: Update Node.js dependencies
      run: |
        cd frontend
        npm update
        npm audit fix
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update dependencies'
        title: 'ðŸ“¦ Dependency Updates'
        body: |
          ## ðŸ“¦ Automated Dependency Updates
          
          This PR contains automated updates to project dependencies.
          
          ### Changes:
          - Updated Python packages (if any)
          - Updated Node.js packages (if any)
          - Fixed security vulnerabilities (if any)
          
          Please review and test before merging.
        branch: dependency-updates
        delete-branch: true